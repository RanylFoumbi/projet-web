/**
  * villus v3.5.0
  * (c) 2024 Abdelrahman Awad
  * @license MIT
  */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vue"),require("graphql")):"function"==typeof define&&define.amd?define(["exports","vue","graphql"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Villus={},e.Vue,e.graphql)}(this,(function(e,t,r){"use strict";function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var o=function(e,t){t||(t={}),"function"==typeof t&&(t={cmp:t});var r,n="boolean"==typeof t.cycles&&t.cycles,o=t.cmp&&(r=t.cmp,function(e){return function(t,n){var o={key:t,value:e[t]},u={key:n,value:e[n]};return r(o,u)}}),u=[];return function e(t){if(t&&t.toJSON&&"function"==typeof t.toJSON&&(t=t.toJSON()),void 0!==t){if("number"==typeof t)return isFinite(t)?""+t:"null";if("object"!=typeof t)return JSON.stringify(t);var r,i;if(Array.isArray(t)){for(i="[",r=0;r<t.length;r++)r&&(i+=","),i+=e(t[r])||"null";return i+"]"}if(null===t)return"null";if(-1!==u.indexOf(t)){if(n)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}var s=u.push(t)-1,a=Object.keys(t).sort(o&&o(t));for(i="",r=0;r<a.length;r++){var l=a[r],c=e(t[l]);c&&(i&&(i+=","),i+=JSON.stringify(l)+":"+c)}return u.splice(s,1),"{"+i+"}"}}(e)},u=n(o);function i(e,r){return t.isRef(e)?e.value:"function"==typeof e?e(t.toValue(r)):e}function s(e){return t.isRef(e)||t.isReactive(e)||"function"==typeof e}function a(e){return e.reduce(((e,t)=>(e[String(t)]=!0,e)),{})}function l(){const e=new Set;return{on:function(t){return e.add(t),()=>{e.delete(t)}},run:async function(...t){for(const r of e)await r(...t)}}}function c(e){return"string"==typeof e?new r.GraphQLError(e):"object"==typeof e&&e.message?new r.GraphQLError(e.message,e.nodes,e.source,e.positions,e.path,e,e.extensions||{}):e}class d extends Error{constructor({response:e,networkError:t,graphqlErrors:r}){const n=null==r?void 0:r.map(c),o=((e,t)=>{let r="";return void 0!==e?r=`[Network] ${e.message}`:(void 0!==t&&t.forEach((e=>{r+=`[GraphQL] ${e.message}\n`})),r.trim())})(t,n);super(o),this.name="CombinedError",this.response=e,this.message=o,this.networkError=t,this.graphqlErrors=n}get isGraphQLError(){return!(!this.graphqlErrors||!this.graphqlErrors.length)}toString(){return this.message}}function f(e){return"string"==typeof e?e:e&&e instanceof String?e.toString():e&&"kind"in e?r.print(e):null}async function h(e){let t;const r={ok:e.ok,statusText:e.statusText,status:e.status,headers:e.headers};try{t=await e.json()}catch(e){return Object.assign(Object.assign({},r),{statusText:e.message,body:null})}return Object.assign(Object.assign({},r),{body:t})}const g={method:"POST",headers:{"content-type":"application/json"}};function v(e,t){return Object.assign(Object.assign(Object.assign({},e),t),{method:t.method||e.method||g.method,headers:Object.assign(Object.assign({},e.headers||{}),t.headers||{})})}function y({query:e,variables:t},r){const n=f(e);if(!n)throw new Error("A query must be provided.");return v({body:JSON.stringify({query:n,variables:t})},r)}function p(e){let t,r,n;for(t=5381,r=0,n=0|e.length;r<n;r++)t=(t<<5)+t+e.charCodeAt(r);return t>>>0}function b(e,...t){const r=e.variables?u(e.variables):"";return p(`${f(e.query)}${r}${t.join("")}`)}function w(){let e={};function t(t){if(!t)return void(e={});const r=Array.isArray(t)?t:[t];if(!r.length)return;const n=a(r);Object.keys(e).forEach((t=>{const r=e[t];if(!r.tags)return;r.tags.some((e=>n[e]))&&delete e[t]}))}function r({afterQuery:r,useResult:n,operation:o}){var u;if("mutation"===o.type&&(null===(u=o.clearCacheTags)||void 0===u?void 0:u.length))return void r((e=>{e.data&&t(o.clearCacheTags)}));if("query"!==o.type||"network-only"===o.cachePolicy)return;r((t=>{!function({key:t,tags:r},n){e[t]={result:n,tags:r}}(o,t)}));const i=function({key:t}){var r;return null===(r=e[t])||void 0===r?void 0:r.result}(o);return"cache-only"===o.cachePolicy?n(i||{data:null,error:null},!0):i?n(i,"cache-first"===o.cachePolicy):void 0}return r.clearCache=t,r}function m(e){const t=(null==e?void 0:e.fetch)||("undefined"!=typeof window&&"fetch"in window&&window.fetch?window.fetch.bind(window):"undefined"!=typeof global&&"fetch"in global?global.fetch:"undefined"!=typeof self&&"fetch"in self?self.fetch:void 0);if(!t)throw new Error("Could not resolve a fetch() method, you should provide one.");return async function(e){var r,n;const{useResult:o,opContext:u,operation:i}=e,s=y(i,u);let a;try{a=await t(u.url,s).then(h)}catch(e){return o({data:null,error:new d({response:a,networkError:e})},!0)}e.response=a;const l=null===(r=a.body)||void 0===r?void 0:r.data;if(!a.ok||!a.body){const e={response:a};return(null===(n=a.body)||void 0===n?void 0:n.errors)?e.graphqlErrors=a.body.errors:e.networkError=new Error(a.statusText),o({data:l,error:new d(e)},!0)}o({data:l,error:a.body.errors?new d({response:a,graphqlErrors:a.body.errors}):null},!0)}}function O(){const e={};return function(t){if("query"!==t.operation.type)return;const{useResult:r}=t;t.afterQuery((()=>{delete e[t.operation.key]}));const n=e[t.operation.key];if(n)return n.then((e=>{r(e,!0)}));let o;e[t.operation.key]=new Promise((e=>{o=e})),t.useResult=function(...e){r(...e),o(e[0])}}}const j=Symbol("villus.client");let x;const E=e=>x=e,q=()=>{var e;const r=t.getCurrentInstance();return r?(null===(e=r.provides)||void 0===e?void 0:e[j])||t.inject(j,x):x},C=()=>[w(),O(),m()];class k{constructor(e){this.install=()=>{},this.url=e.url,this.defaultCachePolicy=e.cachePolicy||"cache-first",this.plugins=e.use||[...C()],this.taggedQueries=[]}async execute(e,t,r,n){let o;const u=Object.assign(Object.assign({url:this.url},g),{headers:Object.assign(Object.assign({},g.headers),(null==r?void 0:r.headers)||{})});let i=!1;const s=[],a={useResult(e,t){t&&(i=!0),o&&(null==n||n(e)),o=e},afterQuery(e){s.push(e)},operation:Object.assign(Object.assign({},e),{key:b(e),type:t,cachePolicy:("cachePolicy"in e?e.cachePolicy:this.defaultCachePolicy)||this.defaultCachePolicy}),opContext:u};let l=0;for(let e=0;e<this.plugins.length;e++){const t=this.plugins[e];if(await t(a),o){l=e;break}}return new Promise(((e,t)=>{o?(e(o),(async()=>{if(!i)for(let e=l+1;e<this.plugins.length;e++){const t=this.plugins[e];await t(a)}const e={response:a.response};for(let t=0;t<s.length;t++){const r=s[t];await r(o,e)}})()):t(new Error("Operation result was not set by any plugin, make sure you have default plugins configured or review documentation"))}))}async executeQuery(e,t,r){return this.execute(e,"query",t,r)}async executeMutation(e,t){return this.execute(e,"mutation",t)}async executeSubscription(e){return await this.execute(e,"subscription")}registerTaggedQuery(e,t){const r=Symbol("Tagged query");return this.taggedQueries.push({id:r,tags:e,refetch:t}),r}unregisterTaggedQuery(e){const t=this.taggedQueries.findIndex((t=>t.id===e));-1!==t&&this.taggedQueries.splice(t,1)}async refetchTaggedQueries(e){const t=a(e),r=this.taggedQueries.filter((e=>e.tags.some((e=>t[e]))));return Promise.all(r.map((e=>e.refetch()))).then((()=>{}))}}function T(e){const t=new k(e);return t.install=e=>{E(t),e.provide(j,t)},t}function Q(){const e=t.getCurrentInstance();let r=e&&t.inject(j,function(e,t){var r,n,o,u;return(null===(n=null===(r=null==e?void 0:e.proxy)||void 0===r?void 0:r._provided)||void 0===n?void 0:n[t])||(null===(o=null==e?void 0:e._provided)||void 0===o?void 0:o[t])||(null===(u=null==e?void 0:e.provides)||void 0===u?void 0:u[t])}(e,j));if(r&&E(r),r=q(),null==r)throw new Error("Cannot detect villus Client, did you forget to call `useClient`? Alternatively, you can explicitly pass a client as the `manualClient` argument.");return r}const P=e=>e.data;const S=e=>e.data;e.Client=k,e.CombinedError=d,e.VILLUS_CLIENT=j,e.cache=w,e.createClient=T,e.dedup=O,e.defaultPlugins=C,e.definePlugin=function(e){return e},e.fetch=m,e.getActiveClient=q,e.getQueryKey=b,e.handleSubscriptions=function(e){const t=e;return async function({operation:e,useResult:r}){if("subscription"!==e.type)return;if(!t)throw new Error("No subscription forwarder was set.");const n=f(e.query);if(!n)throw new Error("A query must be provided.");r(await t(Object.assign(Object.assign({},e),{query:n})),!0)}},e.makeFetchOptions=y,e.mergeFetchOpts=v,e.normalizeQuery=f,e.parseResponse=h,e.setActiveClient=E,e.useClient=function(e){const r=T(e);return t.getCurrentInstance()&&t.provide(j,r),r},e.useMutation=function(e,r){var n;const o=null!==(n=null==r?void 0:r.client)&&void 0!==n?n:Q(),u=t.ref(null),i=t.ref(!1),s=t.ref(!1),a=t.ref(null);let l;return{data:u,isFetching:i,isDone:s,error:a,execute:async function(n){var c,d;i.value=!0;const f=n||{},h=o.executeMutation({query:e,variables:f,clearCacheTags:[...(null==r?void 0:r.clearCacheTags)||[],...(null==r?void 0:r.refetchTags)||[]]},t.toValue(null==r?void 0:r.context));l=h;const g=await h;return t.nextTick((()=>{(null==r?void 0:r.refetchTags)&&o.refetchTaggedQueries(r.refetchTags)})),h!==l?{data:g.data,error:g.error}:(g.data&&(null===(c=null==r?void 0:r.onData)||void 0===c||c.call(r,g.data)),g.error&&(null===(d=null==r?void 0:r.onError)||void 0===d||d.call(r,g.error)),u.value=g.data,a.value=g.error,s.value=!0,i.value=!1,l=void 0,{data:u.value,error:a.value})}}},e.useQuery=function(e,r=P){var n;const o=null!==(n=null==e?void 0:e.client)&&void 0!==n?n:Q();if(e.tags){const r=o.registerTaggedQuery(e.tags,(async()=>{await A()}));t.onBeforeUnmount((()=>{o.unregisterTaggedQuery(r)}))}const{query:a,variables:c,cachePolicy:d,fetchOnMount:f,paused:h,skip:g,onData:v,onError:y}=function(e){const t={variables:{},fetchOnMount:!0};return Object.assign(Object.assign(Object.assign({},t),e),{query:e.query})}(e);let b=f;const w=t.ref(P({data:null,error:null}));let m={data:null,error:null};const O=t.ref(null!=f&&f),j=t.ref(!1),x=t.ref(!0),E=t.ref(null),{on:q,run:C}=l(),{on:k,run:T}=l();let S;v&&q(v),y&&k(y);const V=()=>i(h,c||{});function N(e){e.data&&C(e.data),e.error&&T(e.error),w.value=r(e),E.value=e.error}async function A(r){const n=t.toValue(c)||{};if(i(g,n))return O.value=!1,{data:(null==m?void 0:m.data)||null,error:(null==m?void 0:m.error)||null};O.value=!0;const u=o.executeQuery({query:t.toValue(a),variables:t.toValue((null==r?void 0:r.variables)||n),cachePolicy:(null==r?void 0:r.cachePolicy)||d,tags:null==e?void 0:e.tags},t.toValue(null==e?void 0:e.context),N);S=u;const s=await u;return u!==S||(m=s,N(s),j.value=!0,O.value=!1,x.value=!1,S=void 0),{data:s.data,error:s.error}}function R(){V()||A()}s(a)&&t.watch(a,R),s(h)&&t.watch((()=>!V()),(e=>{e&&x.value&&A()})),function(){let e;c&&s(c)&&t.watch((()=>t.toValue(c)),(t=>{const r=p(u(t));r!==e&&(e=r,x.value=!0,R())}),{deep:!0})}();const M={data:w,isFetching:O,isDone:j,error:E,execute:A,onData:q,onError:k},_=t.getCurrentInstance();return b&&(h&&V()||(_?t.onMounted((()=>A())):A())),Object.assign(Object.assign({},M),{then:async e=>(b=!1,await M.execute(),e(M))})},e.useSubscription=function(e,r=S){var n,o,a;const l=null!==(n=e.client)&&void 0!==n?n:Q(),{query:c,variables:f,paused:h,skip:g}=e,v=null===(o=e.subscribeOnMount)||void 0===o||o,y=t.ref(null!==(a=null==e?void 0:e.initialData)&&void 0!==a?a:r({data:null,error:null},null)),p=t.ref(null),b=t.computed((()=>i(h,f))),w=t.ref(!0);function m(e){y.value=r(e,y.value),p.value=e.error}let O;const j=function(e){let r=[],n=!1;return function(...o){return n||(t.nextTick((()=>{const t=e(...o);r.forEach((e=>e(t))),r=[],n=!1})),n=!0),new Promise((e=>r.push(e)))}}((async function(){if(x(),q())return;w.value=!0;const e=await l.executeSubscription({query:t.toValue(c),variables:t.toValue(f)});return O=e.subscribe({next(e){if(b.value)return;const t=function(e){if(!e.errors)return{data:e.data||null,error:null};return{data:e.data||null,error:new d({graphqlErrors:[...e.errors],response:null})}}(e);w.value=!1,m(t)},complete(){},error(e){if(b.value)return;const t={data:null,error:new d({networkError:e,response:null})};return w.value=!1,m(t)}}),O}));function x(){null==O||O.unsubscribe(),O=void 0}const E=t.getCurrentInstance();function q(){return i(g,t.toValue(f)||{})}return b.value||q()||!v||(E?t.onMounted(j):j()),E&&t.onBeforeUnmount(x),s(h)&&t.watch(h,(e=>{e||j()})),s(c)&&t.watch(c,j),s(f)&&t.watch(f,((e,t)=>{var r;r=t,u(e)!==u(r)&&j()})),s(g)&&t.watch(q,((e,t)=>{e!==t&&(e?x():j())})),{data:y,error:p,paused:b,isFetching:w,subscribe:()=>{j()},unsubscribe:x}}}));